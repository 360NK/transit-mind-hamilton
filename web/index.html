<!DOCTYPE html>
<html>
  <head>
    <title>TransitMind: Hamilton</title>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #111;
        color: white;
        font-family: monospace;
      }
      #container {
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
      }
      #ui {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border: 1px solid #333;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <h2>TRANSITMIND</h2>
      <div id="status">Connecting to Neural Net...</div>
    </div>
    <div id="container"></div>
    <script>
      const MAPBOX_TOKEN =
        "pk.eyJ1IjoidHJhbnNpdG1pbmQiLCJhIjoiY2x0eHViZzFqMDBjazJqbXF5bmd5dnc3diJ9.generic_token_placeholder"

      const { DeckGL, GeoJsonLayer } = deck

      const deckgl = new DeckGL({
        container: "container",
        mapStyle: "mapbox://styles/mapbox/dark-v11",
        mapboxApiAccessToken: MAPBOX_TOKEN,
        initialViewState: {
          longitude: -79.866091,
          latitude: 43.256568,
          zoom: 12,
          pitch: 45, // Tilted 3D view
          bearing: 0,
        },
        controller: true,
        layers: [], // We start empty
      })

      async function renderLayers() {
        try {
          // 1. Fetch Cleaned Data
          const busResp = await fetch("http://127.0.0.1:8000/busses")
          const busData = await busResp.json()

          const conflictResp = await fetch("http://127.0.0.1:8000/conflicts")
          const conflictData = await conflictResp.json()

          // UI Update
          const count = busData.features ? busData.features.length : 0
          document.getElementById(
            "status"
          ).innerText = `LIVE: Tracking ${count} Vehicles`

          // -------------------------------------------
          // LAYER 1: ROUTE TRACKS (The "White Lines")
          // -------------------------------------------
          // We extract the route_geometry from the bus properties to create a new dataset
          const routeFeatures = busData.features
            .filter((f) => f.properties.route_geometry) // Only if route exists
            .map((f) => ({
              type: "Feature",
              geometry: f.properties.route_geometry,
              properties: { route_id: f.properties.route_id },
            }))

          const trackLayer = new GeoJsonLayer({
            id: "tracks",
            data: { type: "FeatureCollection", features: routeFeatures },
            stroked: true,
            getLineColor: [100, 100, 100, 150], // Grey, semi-transparent
            getLineWidth: 20,
            pickable: false,
          })

          // -------------------------------------------
          // LAYER 2: CONFLICTS (The "Pothole")
          // -------------------------------------------
          const conflictLayer = new GeoJsonLayer({
            id: "conflicts",
            data: conflictData,
            filled: true,
            stroked: true,
            getFillColor: [255, 0, 0, 100], // Red, transparent
            getLineColor: [255, 0, 0, 255], // Solid Red outline
            getLineWidth: 40,
            pickable: true,
          })

          // -------------------------------------------
          // LAYER 3: BUSSES (The "Dots")
          // -------------------------------------------
          const busLayer = new GeoJsonLayer({
            id: "busses",
            data: busData,
            pointRadiusMinPixels: 4,
            pointRadiusScale: 1,
            getPointRadius: 20,
            getFillColor: (d) => {
              // If speed is 0, make it bright Red. Otherwise Neon Green.
              return d.properties.speed === 0 ? [255, 0, 0] : [0, 255, 100]
            },
            pickable: true,
            onClick: (info) =>
              alert(
                `Bus: ${info.object.properties.vehicle_id}\nRoute: ${info.object.properties.route_id}`
              ),
          })

          // Render Order: Tracks (Bottom) -> Conflicts -> Busses (Top)
          deckgl.setProps({
            layers: [trackLayer, conflictLayer, busLayer],
          })
        } catch (err) {
          console.error("Render Error:", err)
          document.getElementById("status").innerText = "SYSTEM ERROR"
          document.getElementById("status").style.color = "red"
        }
      }

      async function startLiveMap() {
        await renderLayers() // Wait for this to finish
        setTimeout(startLiveMap, 5000) // THEN wait 5 seconds before trying again
      }

      startLiveMap()
    </script>
  </body>
</html>
